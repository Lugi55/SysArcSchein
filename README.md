# SysArc

## Overview
![GitHub Logo](/images/UML.png)

## Tasks
|          |SensorTask|GUITask|LoggerTask|CommunicationTask|RFIDTask|
|:--------:|:--------:|:-----:|:--------:|:---------------:|:------:|
|language  |Python3   |Python3|Python3   |Python3          |Python2 |
|nicenes   |-10       |0      |10        |-10              |0       |
|crucial   |x         |       |          |x                |        |

### SensorTask
All sensor related Tasks are handeled here.
The main duty of the Task is to get muliple sensorvalues and build a json file with them.
There are two states in witch the Task can bee.
If no user is logged in to the system than only a few of the sensors will be avaluated. 
Also the frequency in witch the values are measured is decreased.
The reasoning behind that is that a parking car the most sensor values arent that interesting.
the folloing diagramm shows the main loop for publishing sensor datata to the local mqtt.
<br />
<img src="/images/SensorTask_1.png" alt="drawing" width="300"/>
<br />
There must be posibility for an user to login to a car.
The **RFIDTask** can publish an UserID witch the **SensorTask** subscribe to.
For validation of the UserId we have to ask the web databank.
There fore a request is been puflished after reciving an UserID.
The following diagramm shows callback function for an incoming mqtt message from the **RFIDTask**.
<br />
<img src="/images/SensorTask_2.png" alt="drawing" width="200"/>
<br />
The **SensorTask** subscribe to the topic ``<local>com2/car`` with is used to get response from the web.
The message can be triggerd by a request from the RFID UserID or a login via web.
The incoming Message contains information about the user, validation and if its an login or logout message.
The following diagramm shows the callback function triggerd by the topic ``<local>com2/car``
<br />
<img src="/images/SensorTask_3.png" alt="drawing" width="200"/>
<br />


status|LIDAR|Humidity|SteeringAngle|Temperature|Speed|Altimeter|Acceleration|Magnetometer|Gyro|Measurement Period|
|:----:|:----:|:----:|:----:|:----:|:----:|:----:|:----:|:----:|:----:|----:|
|login|x|x|x|x|x|x|x|x|x|0.1s|
|logout||||x|||x||x|1s|

### GUITask

### LoggerTask
The Sensor values generated from the **SensorTask** are logged in this Task.
All json strings emmited by the **SensorTask** are dumped in to an file.
Every full hour a new file will be generated in the LoggerData directory.
The name of the file hints the time at witch the file has been created.
If the number of files is getting bigger than a maximal Value the last file is removed.
The maximal Number of files can be alterd by changing the variable ``maxFileNumber`` in **constants.py**. 
The LoggerTask subscibe to the topic <local>sensor and get periodicly a json file with sensor values.
The Task is only running in the callback function generated by an incoming mqtt message.
The following diagram shows the funktion of the callback function.
<br />
<img src="/images/LoggerTask.png" alt="drawing" width="300"/>
<br />
The sensor cheks if a new file must be created.
A new File must be created if the hour has incremented.
Every time a new file is beeing created we have to check the total amout of file.


### CommunicationTask

### RFIDTask
For login or logout via RFID this task is used. The **RFIDTask** implements an libary to read and RFID tag.
If a tag is detected a mqtt message is published to the topic ``<local>RFID``.
the following diagram shows the procedure.
<br />
<img src="/images/RFIDTask.png" alt="drawing" width="300"/>
<br />
To prevent mulible signal a timeout with each succefull detection is added. 

### constants
The python module ``constants.py`` is used to store values witch are used in mulitple tasks.
For example the updaterates of the **SensorTask** can be altered by changing variables here.

## Communication
For Communication between web and car mqqt is used.
For the local IPC also mqtt is used.
The global topics and local topics are almost the same.
Also messages trasmited over these topics are equal.
All messages that are transmitted to the must be bufferd. 
There fore an own Task is used. 
The **CommunicationTask** is responsible for the connection between local and global and buffering the output.
Over the global topics standardized json frames are transmited.


#### global topics
``<V3>/sensor``
``<V3>/com2/web``
``<V3>/com2/car``
#### local topics
``<local>/sensor``
``<local>/com2/car``
``<local>/com2/web``
``<local>/RFID``


### Json Sensor Frame
With this frame sensor values are transmited.
```json
{
"SensorValue1": [
	{"name":"LIDAR","timestamp":"number","value":"number",},
	{"name":"Humidity","timestamp":"number","value":"number"},
	{"name":"SteeringAngle","timestamp":"number","value":"number"},
	{"name":"Temperature","timestamp":"number","value":"number"},
	{"name":"Speed","timestamp":"number","value":"number"},
	{"name":"Altimeter","timestamp":"number","value":"number"}
	],
"SensorValue3": [
	{"name":"Acceleration","timestamp":"number","valueX":"number", "valueY":"number", "valueZ":"number"},
	{"name":"Magnetometer","timestamp":"number","valueX":"number", "valueY":"number", "valueZ":"number"},
	{"name":"Gyro","timestamp":"number","valueX":"number", "valueY":"number", "valueZ":"number"}
	]
}
```

### Json com2car Frame
With this Frame the communication to the car from the web is handeld.
It is needed for the login procedure. 
```json
{
"timestamp":"number",
"login":"bool",
"certified":"bool",
"tokenID":"string",
"user":{	
	"userName":"string",
	"fullName":"string",
	"email":"string"
	}
}
```
### Json com2web Frame
With this frame the communication to the web from the car is handeld.
Main use is for tranmitting a tockenID for the login.
```json
{
"timestamp":"number",
"tokenID":"string",
"login":"bool"
}
```

## Car Web Interface sequence diagram
The following swquence diagramm shows the communication between web and car.
<img src="/images/WebCarInterface.png" alt="drawing" width="700"/>
## Login Logout sequence diagram
<img src="/images/loginlogout.png" alt="drawing" width="700"/>
## Sensor publish sequence diagram
<img src="/images/SensorLoop.png" alt="drawing" width="700"/>



## Python requirements
## Mqtt requrements
## IMU requrements

## Installation

## division of labor
||SensorTask|GUITask|LoggerTask|CommunicationTask|RFIDTask|TestTask|RFIDTest|start.bat|sum
|:---------:|:-----:|:--------:|:---------------:|:------:|:------:|:------:|:-------:|:---:|:---:|
|Luginsland|10h||5h||2h||2h|1h|35h
|Casagranda||15h||20h||6h|1h|1h|42h
